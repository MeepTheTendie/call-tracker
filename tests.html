<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Call Tracker Tests</title>
  <style>
    body {
      font-family: monospace;
      background: #f5f5f5;
      padding: 20px;
    }
    .test-result {
      margin: 5px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .summary {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="summary">
    <h1>Call Tracker Unit Tests</h1>
    <div id="results"></div>
  </div>

  <script>
    // Mock localStorage for testing
    const mockStorage = {};
    const localStorageMock = {
      getItem: (key) => mockStorage[key] || null,
      setItem: (key, value) => { mockStorage[key] = value; },
      removeItem: (key) => { delete mockStorage[key]; },
      clear: () => { Object.keys(mockStorage).forEach(key => delete mockStorage[key]); }
    };
    Object.defineProperty(window, 'localStorage', { value: localStorageMock });

    // Test framework
    class TestRunner {
      constructor() {
        this.tests = [];
        this.passed = 0;
        this.failed = 0;
      }

      test(name, fn) {
        this.tests.push({ name, fn });
      }

      assert(condition, message) {
        if (!condition) {
          throw new Error(message || 'Assertion failed');
        }
      }

      assertEqual(actual, expected, message) {
        if (actual !== expected) {
          throw new Error(message || `Expected ${expected}, got ${actual}`);
        }
      }

      run() {
        const results = document.getElementById('results');
        results.innerHTML = '';

        this.tests.forEach(test => {
          try {
            // Reset mock storage before each test
            localStorageMock.clear();
            mockStorage.calls = [];
            
            test.fn();
            this.passed++;
            results.innerHTML += `<div class="test-result pass">âœ“ ${test.name}</div>`;
          } catch (error) {
            this.failed++;
            results.innerHTML += `<div class="test-result fail">âœ— ${test.name}: ${error.message}</div>`;
          }
        });

        const total = this.tests.length;
        const passRate = Math.round((this.passed / total) * 100);
        results.innerHTML += `
          <div class="summary">
            <h2>Test Results</h2>
            <p>Total: ${total}, Passed: ${this.passed}, Failed: ${this.failed}</p>
            <p>Pass Rate: ${passRate}%</p>
          </div>
        `;
      }
    }

    const runner = new TestRunner();

    // Mock DOM elements
    const mockElements = {};
    function mockGetElementById(id) {
      if (!mockElements[id]) {
        mockElements[id] = {
          textContent: '',
          className: '',
          style: { width: '0%' },
          innerHTML: ''
        };
      }
      return mockElements[id];
    }
    
    // Mock document methods
    document.getElementById = mockGetElementById;
    document.addEventListener = () => {}; // Mock event listener
    global.confirm = () => true; // Mock confirm dialog

    // Load the Call Tracker App (copy from main file)
    const App = {
      calls: [],
      dailyGoal: 80,

      init() {
        this.load();
        this.render();
        this.bindEvents();
      },

      load() {
        const saved = localStorage.getItem('callTracker');
        if (saved) {
          try {
            const data = JSON.parse(saved);
            this.calls = data.calls || [];
            this.dailyGoal = data.dailyGoal || 80;
          } catch {}
        }
      },

      save() {
        localStorage.setItem('callTracker', JSON.stringify({
          calls: this.calls,
          dailyGoal: this.dailyGoal
        }));
      },

      getTodayCalls() {
        const today = new Date().toDateString();
        return this.calls.filter(c => new Date(c.timestamp).toDateString() === today).length;
      },

      logCall() {
        const now = new Date();
        this.calls.push({ timestamp: now.toISOString() });
        this.save();
        this.render();
      },

      clearHistory() {
        if (confirm('Clear all calls?')) {
          this.calls = [];
          this.save();
          this.render();
        }
      },

      render() {
        const todayCount = this.getTodayCalls();
        const todayEl = document.getElementById('today');
        todayEl.textContent = todayCount;
        todayEl.className = 'dials-count' + (todayCount >= this.dailyGoal ? ' complete' : '');
        
        const progress = Math.min(100, Math.round((todayCount / this.dailyGoal) * 100));
        const remaining = Math.max(0, this.dailyGoal - todayCount);
        const goalReached = todayCount >= this.dailyGoal;
        
        document.getElementById('goalPercent').textContent = progress + '%';
        const fill = document.getElementById('goalFill');
        fill.style.width = progress + '%';
        fill.className = 'goal-fill' + (goalReached ? ' complete' : '');
        
        const text = document.getElementById('goalText');
        if (goalReached) {
          text.textContent = 'Goal reached! ðŸŽ‰';
          text.className = 'goal-text complete';
        } else {
          text.textContent = remaining + ' more to reach goal';
          text.className = 'goal-text';
        }
        
        const list = document.getElementById('callList');
        const recent = this.calls.slice(-8).reverse();
        if (recent.length === 0) {
          list.innerHTML = '<div style="color:#52525b;text-align:center;padding:16px">No calls yet</div>';
          return;
        }
        list.innerHTML = recent.map(c => {
          const date = new Date(c.timestamp);
          return `<div class="call-item"><span class="call-time">${date.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true})}</span></div>`;
        }).join('');
      },

      bindEvents() {
        document.getElementById('logBtn').onclick = () => this.logCall();
        document.getElementById('clearBtn').onclick = () => this.clearHistory();
        document.addEventListener('keydown', e => {
          if (e.key === 'c' && e.shiftKey && (e.metaKey || e.ctrlKey)) {
            e.preventDefault();
            this.logCall();
          }
        });
      }
    };

    // Unit Tests
    runner.test('should initialize with default values', () => {
      App.init();
      runner.assertEqual(App.calls.length, 0);
      runner.assertEqual(App.dailyGoal, 80);
    });

    runner.test('should save and load data from localStorage', () => {
      const testData = {
        calls: [{ timestamp: new Date().toISOString() }],
        dailyGoal: 100
      };
      localStorage.setItem('callTracker', JSON.stringify(testData));
      
      App.load();
      runner.assertEqual(App.calls.length, 1);
      runner.assertEqual(App.dailyGoal, 100);
    });

    runner.test('should handle corrupted localStorage data', () => {
      localStorage.setItem('callTracker', 'invalid json');
      App.load();
      runner.assertEqual(App.calls.length, 0);
      runner.assertEqual(App.dailyGoal, 80);
    });

    runner.test('should log a call correctly', () => {
      App.calls = [];
      App.logCall();
      runner.assertEqual(App.calls.length, 1);
      runner.assert(App.calls[0].timestamp);
      runner.assert(typeof new Date(App.calls[0].timestamp).toISOString() === 'string');
    });

    runner.test('should save to localStorage after logging call', () => {
      App.calls = [];
      App.logCall();
      const saved = JSON.parse(localStorage.getItem('callTracker'));
      runner.assertEqual(saved.calls.length, 1);
    });

    runner.test('should clear history when confirmed', () => {
      App.calls = [{ timestamp: new Date().toISOString() }];
      App.clearHistory();
      runner.assertEqual(App.calls.length, 0);
    });

    runner.test('should get today\'s calls correctly', () => {
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      App.calls = [
        { timestamp: today.toISOString() },
        { timestamp: yesterday.toISOString() },
        { timestamp: today.toISOString() }
      ];
      
      const todayCalls = App.getTodayCalls();
      runner.assertEqual(todayCalls, 2);
    });

    runner.test('should render zero calls correctly', () => {
      App.calls = [];
      App.render();
      
      const todayEl = document.getElementById('today');
      runner.assertEqual(todayEl.textContent, '0');
      runner.assertEqual(todayEl.className, 'dials-count');
      
      const goalText = document.getElementById('goalText');
      runner.assertEqual(goalText.textContent, '80 more to reach goal');
    });

    runner.test('should render progress correctly', () => {
      App.calls = [];
      App.dailyGoal = 10;
      
      // Add 4 calls
      for (let i = 0; i < 4; i++) {
        App.logCall();
      }
      
      const todayCount = App.getTodayCalls();
      runner.assertEqual(todayCount, 4);
      
      const goalPercent = document.getElementById('goalPercent');
      runner.assertEqual(goalPercent.textContent, '40%');
      
      const goalFill = document.getElementById('goalFill');
      runner.assertEqual(goalFill.style.width, '40%');
    });

    runner.test('should handle goal completion correctly', () => {
      App.calls = [];
      App.dailyGoal = 5;
      
      // Add 5 calls to reach goal
      for (let i = 0; i < 5; i++) {
        App.logCall();
      }
      
      const todayEl = document.getElementById('today');
      runner.assertEqual(todayEl.className, 'dials-count complete');
      
      const goalText = document.getElementById('goalText');
      runner.assertEqual(goalText.textContent, 'Goal reached! ðŸŽ‰');
      runner.assertEqual(goalText.className, 'goal-text complete');
    });

    runner.test('should not exceed 100% progress', () => {
      App.calls = [];
      App.dailyGoal = 5;
      
      // Add 10 calls (double the goal)
      for (let i = 0; i < 10; i++) {
        App.logCall();
      }
      
      const goalPercent = document.getElementById('goalPercent');
      runner.assertEqual(goalPercent.textContent, '100%');
    });

    runner.test('should render call list with timestamps', () => {
      App.calls = [];
      
      // Add calls at different times
      const now = new Date();
      const timestamps = [
        new Date(now.getTime() - 3600000), // 1 hour ago
        new Date(now.getTime() - 1800000), // 30 minutes ago
        now // now
      ];
      
      timestamps.forEach(time => {
        App.calls.push({ timestamp: time.toISOString() });
      });
      
      App.render();
      
      const callList = document.getElementById('callList');
      runner.assert(callList.innerHTML.includes('call-item'));
      runner.assert(callList.innerHTML.includes('call-time'));
    });

    runner.test('should display "No calls yet" when empty', () => {
      App.calls = [];
      App.render();
      
      const callList = document.getElementById('callList');
      runner.assert(callList.innerHTML.includes('No calls yet'));
    });

    runner.test('should limit recent calls to 8 items', () => {
      App.calls = [];
      
      // Add 10 calls
      for (let i = 0; i < 10; i++) {
        App.calls.push({ timestamp: new Date().toISOString() });
      }
      
      App.render();
      
      const callList = document.getElementById('callList');
      // Should only show 8 items (recent ones)
      const matches = callList.innerHTML.match(/call-item/g);
      runner.assertEqual(matches ? matches.length : 0, 8);
    });

    runner.test('should handle date filtering correctly', () => {
      App.calls = [];
      
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      // Add calls from today and yesterday
      App.calls.push({ timestamp: today.toISOString() });
      App.calls.push({ timestamp: yesterday.toISOString() });
      
      const todayCalls = App.getTodayCalls();
      runner.assertEqual(todayCalls, 1);
    });

    // Run all tests
    window.addEventListener('DOMContentLoaded', () => {
      runner.run();
    });
  </script>
</body>
</html>